<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://doishmxydgslswzhtlpi.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvaXNobXh5ZGdzbHN3emh0bHBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNzMyNjcsImV4cCI6MjA2Nzc0OTI2N30.8ozjig0LVvZdif9VuoEkqDcqbA89yliFArPOGcTUz5E";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = id => document.getElementById(id);
const fields = {
  ventanilla_low: $('ventanilla_low'),
  ventanilla_high: $('ventanilla_high'),
  deposito_low: $('deposito_low'),
  deposito_high: $('deposito_high'),
  otros: $('otros'),
  apolonio: $('apolonio'),
};
let currentData = null;

async function loadRates() {
  const { data, error } = await supabase
    .from('exchange_rates')
    .select('rates, updated_at')
    .eq('id', 1)
    .single();
  if (error) { alert(error.message); return; }
  currentData = data.rates || {};
  fields.ventanilla_low.value  = currentData?.ventanilla?.low  ?? '';
  fields.ventanilla_high.value = currentData?.ventanilla?.high ?? '';
  fields.deposito_low.value    = currentData?.deposito?.low    ?? '';
  fields.deposito_high.value   = currentData?.deposito?.high   ?? '';
  fields.otros.value           = currentData?.otros            ?? '';
  fields.apolonio.value        = currentData?.apolonio         ?? '';
  $('last-updated').textContent = data.updated_at ? 
    `Última actualización: ${new Date(data.updated_at).toLocaleString()}` : '';
}

const toNumOr = (v, fallback) => v === '' || v == null ? fallback : Number(v);
function buildJson() {
  const base = currentData || {};
  return {
    otros:     toNumOr(fields.otros.value, base.otros),
    apolonio:  toNumOr(fields.apolonio.value, base.apolonio),
    deposito:  { low: toNumOr(fields.deposito_low.value, base?.deposito?.low),
                 high: toNumOr(fields.deposito_high.value, base?.deposito?.high) },
    ventanilla:{ low: toNumOr(fields.ventanilla_low.value, base?.ventanilla?.low),
                 high: toNumOr(fields.ventanilla_high.value, base?.ventanilla?.high) }
  };
}

async function saveRates() {
  const payload = buildJson();
  const { error } = await supabase
    .from('exchange_rates')
    .update({ rates: payload, updated_at: new Date().toISOString() })
    .eq('id', 1);
  if (error) alert(error.message);
  else { alert("¡Actualizado!"); await loadRates(); }
}

$('login').onclick = async () => {
  const { error } = await supabase.auth.signInWithPassword({
    email: $('email').value.trim(),
    password: $('password').value
  });
  if (error) alert(error.message);
};
$('signup').onclick = async () => {
  const { error } = await supabase.auth.signUp({
    email: $('email').value.trim(),
    password: $('password').value
  });
  if (error) alert(error.message);
  else alert("Revisa tu correo para confirmar.");
};
$('logout').onclick = async () => { await supabase.auth.signOut(); location.reload(); };
$('save').onclick = saveRates;
$('reload').onclick = loadRates;

supabase.auth.onAuthStateChange(async (_e, s) => {
  const authed = !!s?.user;
  $('signed-out').style.display = authed ? 'none' : 'block';
  $('signed-in').style.display  = authed ? 'block' : 'none';
  $('form').style.display       = authed ? 'block' : 'none';
  $('user-email').textContent   = s?.user?.email || '';
  if (authed) await loadRates();
});
</script>
