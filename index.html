<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Actualizar Tipo de Cambio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; max-width: 720px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    label { display:block; font-weight: 600; margin-top: 8px; }
    input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-top: 4px; font-size: 16px; }
    button { padding: 10px 14px; border: 1px solid #333; background: #111; color: #fff; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #fff; color: #111; margin-left: 8px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muted { color:#666; font-size: 12px; }
    .right { text-align: right; }
    .error { color: #b00020; margin-top: 8px; }
    .ok { color: #0a7a24; margin-top: 8px; }
    .hint { font-size: 12px; color: #444; margin-top: 8px; }
    .disabled { opacity: .6; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>Actualizar tipo de cambio</h1>
  <p class="muted">JSON en <code>public.exchange_rates.rates</code> (id=1): <code>{ otros, apolonio, deposito {low, high}, ventanilla {low, high} }</code></p>

  <div id="auth" class="card">
    <h2>Acceso</h2>
    <div id="signed-out">
      <label>Email</label>
      <input id="email" type="email" placeholder="admin@tudominio.com" />
      <label>Contrase√±a</label>
      <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div style="margin-top:12px;">
        <button id="login">Iniciar sesi√≥n</button>
        <button id="signup" class="secondary">Crear usuario</button>
      </div>
      <div id="auth-msg" class="error"></div>
    </div>
    <div id="signed-in" style="display:none;">
      <div>Sesi√≥n iniciada: <span id="user-email"></span></div>
      <div class="right"><button id="logout" class="secondary">Cerrar sesi√≥n</button></div>
    </div>
  </div>

  <div id="form" class="card">
    <h2>Valores actuales</h2>
    <div class="row">
      <div>
        <label>Ventanilla low (hasta 800)</label>
        <input id="ventanilla_low" type="number" step="0.01" />
      </div>
      <div>
        <label>Ventanilla high (801+)</label>
        <input id="ventanilla_high" type="number" step="0.01" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Dep√≥sito low</label>
        <input id="deposito_low" type="number" step="0.01" />
      </div>
      <div>
        <label>Dep√≥sito high</label>
        <input id="deposito_high" type="number" step="0.01" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Otros</label>
        <input id="otros" type="number" step="0.01" />
      </div>
      <div>
        <label>Apolonio</label>
        <input id="apolonio" type="number" step="0.01" />
      </div>
    </div>

    <div style="margin-top:16px;">
      <button id="save">Guardar</button>
      <button id="reload" class="secondary">Recargar</button>
    </div>
    <div id="save-msg"></div>
    <p class="muted" id="last-updated"></p>
    <p id="save-hint" class="hint"></p>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // üîß Tus credenciales
    const SUPABASE_URL = "https://doishmxydgslswzhtlpi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvaXNobXh5ZGdzbHN3emh0bHBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNzMyNjcsImV4cCI6MjA2Nzc0OTI2N30.8ozjig0LVvZdif9VuoEkqDcqbA89yliFArPOGcTUz5E";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const setMsg = (txt, cls="") => { const el=$('save-msg'); el.className=cls; el.textContent=txt; };
    const setHint = (txt) => { $('save-hint').textContent = txt || ""; };

    const fields = {
      ventanilla_low: $('ventanilla_low'),
      ventanilla_high: $('ventanilla_high'),
      deposito_low: $('deposito_low'),
      deposito_high: $('deposito_high'),
      otros: $('otros'),
      apolonio: $('apolonio'),
    };

    let currentData = null;
    let isAuthed = false;

    // === LECTURA: SIEMPRE (con o sin sesi√≥n) ===
    async function loadRates() {
      setMsg("Cargando‚Ä¶");
      try {
        const { data, error } = await supabase
          .from('exchange_rates')
          .select('rates, updated_at')
          .eq('id', 1)
          .single();

        if (error) { setMsg('Error cargando: ' + error.message, 'error'); return; }

        currentData = data?.rates || {};
        fields.ventanilla_low.value  = currentData?.ventanilla?.low  ?? '';
        fields.ventanilla_high.value = currentData?.ventanilla?.high ?? '';
        fields.deposito_low.value    = currentData?.deposito?.low    ?? '';
        fields.deposito_high.value   = currentData?.deposito?.high   ?? '';
        fields.otros.value           = currentData?.otros            ?? '';
        fields.apolonio.value        = currentData?.apolonio         ?? '';

        $('last-updated').textContent =
          data?.updated_at ? `√öltima actualizaci√≥n: ${new Date(data.updated_at).toLocaleString()}` : '';
        setMsg('');
      } catch (e) {
        setMsg('Error de red: ' + e.message, 'error');
      }
    }

    // === MERGE: no pisa con null ===
    const toNumOr = (val, fallback) => {
      if (val === '' || val === null || val === undefined) return fallback;
      const n = Number(val);
      return Number.isFinite(n) ? n : fallback;
    };
    function buildMergedJson() {
      const base = currentData || {
        otros: null, apolonio: null,
        deposito: { low: null, high: null },
        ventanilla: { low: null, high: null }
      };
      const merged = {
        otros:     toNumOr(fields.otros.value, base.otros),
        apolonio:  toNumOr(fields.apolonio.value, base.apolonio),
        deposito:  {
          low:  toNumOr(fields.deposito_low.value,  base?.deposito?.low),
          high: toNumOr(fields.deposito_high.value, base?.deposito?.high),
        },
        ventanilla:{
          low:  toNumOr(fields.ventanilla_low.value,  base?.ventanilla?.low),
          high: toNumOr(fields.ventanilla_high.value, base?.ventanilla?.high),
        },
      };
      const all = [merged.otros, merged.apolonio, merged.deposito.low, merged.deposito.high, merged.ventanilla.low, merged.ventanilla.high];
      if (!all.every(Number.isFinite)) return { error: 'Hay valores vac√≠os o no num√©ricos.' };
      return { data: merged };
    }

    // === ESCRITURA: s√≥lo si hay sesi√≥n ===
    async function saveRates() {
      if (!isAuthed) { setMsg('Inicia sesi√≥n para guardar.', 'error'); return; }

      const built = buildMergedJson();
      if (built.error) { setMsg(built.error, 'error'); return; }

      setMsg("Guardando‚Ä¶");
      const { error } = await supabase
        .from('exchange_rates')
        .update({
          rates: built.data,
          updated_at: new Date().toISOString()
        })
        .eq('id', 1);

      if (error) setMsg('Error guardando: ' + error.message, 'error');
      else { setMsg('¬°Actualizado correctamente!', 'ok'); await loadRates(); }
    }

    // === Auth UI ===
    $('login').onclick = async () => {
      const email = $('email').value.trim();
      const password = $('password').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) $('auth-msg').textContent = error.message;
    };
    $('signup').onclick = async () => {
      const email = $('email').value.trim();
      const password = $('password').value;
      const { error } = await supabase.auth.signUp({ email, password });
      $('auth-msg').textContent = error ? error.message : 'Revisa tu email para confirmar.';
    };
    $('logout').onclick = async () => {
      try { await supabase.auth.signOut(); }
      finally { location.reload(); }
    };

    $('save').onclick = saveRates;
    $('reload').onclick = loadRates;

    // Estado visual del bot√≥n "Guardar"
    function updateSaveEnabled() {
      if (isAuthed) {
        $('save').classList.remove('disabled');
      } else {
        $('save').classList.add('disabled');
      }
      setHint(isAuthed ? '' : 'Puedes ver los valores sin iniciar sesi√≥n. Para GUARDAR, inicia sesi√≥n arriba.');
    }

    // üîÅ Siempre refrescamos lectura al cambiar la sesi√≥n
    supabase.auth.onAuthStateChange(async (_event, session) => {
      isAuthed = !!session?.user;
      $('signed-out').style.display = isAuthed ? 'none' : 'block';
      $('signed-in').style.display  = isAuthed ? 'block' : 'none';
      $('user-email').textContent   = session?.user?.email ?? '';
      updateSaveEnabled();
      await loadRates(); // <- lee SIEMPRE
    });

    // Primer render: leer SIN depender de la sesi√≥n
    (async () => {
      updateSaveEnabled();
      await loadRates();
    })();

    // Mostrar errores JS en la p√°gina
    window.onerror = (msg) => setMsg('Error: ' + msg, 'error');
  </script>
</body>
</html>
